================================================================================
  Licensed to the Apache Software Foundation (ASF) under one or more
  contributor license agreements.  See the NOTICE file distributed with
  this work for additional information regarding copyright ownership.
  The ASF licenses this file to You under the Apache License, Version 2.0
  (the "License"); you may not use this file except in compliance with
  the License.  You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
================================================================================

$Id$

                         =================================
                         Apache Tomcat 6.0 Patch Proposals
                         =================================


RELEASE SHOWSTOPPERS:


PATCHES ACCEPTED TO BACKPORT:
  [ start all new proposals below, under PATCHES PROPOSED. ]


PATCHES PROPOSED TO BACKPORT:
  [ New proposals should be added at the end of the list ]

* Fix the maven stuff for the maven repo.
  Before it does't find tomcat-juli.jar and the remoteRepository seems broken .
  http://people.apache.org/~jfclere/patches/maven.patch
  +1: jfclere
  -1: fhanik - easier to pass in the root path (lib/bin) to the macro instead of hacking around it
               if we remove the SCP auto feature, then there should be something to replace it with
               (http://ant.apache.org/manual/OptionalTasks/scp.html)  

* Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=48545
  Truststores don't have to have passwords
  Based on a patch by 'smmwpf54'
  http://svn.apache.org/viewvc?view=revision&revision=910266
  +1: markt
  -1: jfclere: Doc says it should use keystorePass (http://tomcat.apache.org/tomcat-6.0-doc/config/http.html).
               so that would break existing configurations.
      markt: It shouldn't break existing configs. JSSE allows trust stores to be
             read without providing the password

* Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=48589
  Make JNDIRealm easier to extend
  Based on a patch by Candid Dauth
  http://svn.apache.org/viewvc?rev=910485&view=rev
  http://svn.apache.org/viewvc?rev=918489&view=rev (review feedback)
  http://svn.apache.org/viewvc?rev=918803&view=rev (additional patch)
  +1: markt, kkolinko, rjung
  -1: 

  Additional patch:
  http://svn.apache.org/viewvc?view=revision&revision=932357
  +1: markt, kkolinko, rjung
  -1:

  Additional patch:
  http://svn.apache.org/viewvc?rev=935983&view=rev
  +1: kkolinko, markt, rjung
  -1:

  rjung: It seems we add roles to the user's role list in
  getRoles(DirContext context, User user) every time it is
  being called, if either commonRole is used or roleFormat / roleName?
  I think we shouldn't change the original list, but instead a copy?

* Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=48729
  Return roles defined by both userRoleName and roleName mechanisms
  Patch provided by 'eric'
  http://svn.apache.org/viewvc?view=revision&revision=920824
  +1: markt, kkolinko
  -1: 
  rjung: see comment to the proposal above.

* Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=48701
  Take account of TagVariableInfo when implementing the rules of JSP.5.3
  http://people.apache.org/~markt/patches/2010-03-09-bug48701.patch
  +1: markt, kkolinko
  -1: 
  rjung: Patch withdrawn on p.a.o?

* Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=48795
  Provide an option to allow recompilation on the next request following a JSP
  compilation error rather than waiting modifcationTestInterval before the next
  attempt
  http://svn.apache.org/viewvc?rev=922010&view=rev
  +1: markt, kkolinko, rjung
  -1: 
  rjung: Minor nit: we could add the actual value to the message "Invalid value ...".

  kkolinko: We have to mention the new parameter in jasper-howto.html#Configuration

* Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=48840
  If CDPATH is set, cd may result in output to stdout.
  Swallow the output. This is safe since the script outputs the value used for
  CATALINA_HOME so any issues will be visible then.
  Patch provided by mdietze
  http://svn.apache.org/viewvc?rev=928732&view=rev
  +1: markt
  -1: 
  rjung: I wouldn't redirect "2>&1". At least my tests show, that CDPATH
  output goes to stdout. stderr would still show, whether an error occured
  during the "cd".

* Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=48843
  Port deadlock prevention for worker allocation from NIO to BIO and APR
  https://issues.apache.org/bugzilla/attachment.cgi?id=25225
  +1: kkolinko, markt, rjung
  -1:

* Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=49030
  Failure of one connector should not leave some connectors started and some
  ignored
  http://svn.apache.org/viewvc?rev=929521&view=rev
  +1: markt
  -1: 
  +0: kkolinko: good, but maybe we should also prevent against starting
    those connectors, that failed to initialize, in StandardService#start()?
    Also the message name (some generic name, "connector.failed"), vs.
    message text ("starting"),  vs. what actually happened (initialize()) -
    I won't insist on fixing that inconsistency.

* Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=48379
  Make session cookie name, domain and path configurable per context.
  http://people.apache.org/~markt/patches/2010-05-05-bug48379.patch
  +1: markt, rjung
  -1: kkolinko
   kkolinko: (Trivial:
     in JvmRouteBinderValve#setNewSessionCookie()
     in if (log.isDebugEnabled()) { ... } block
     s/Globals.SESSION_COOKIE_NAME/newCookie.getName()/
   )

   rjung: In CoyoteAdapter.parseSessionCookiesId(): should there be a check
   for context != null before calling context.getSessionCookieName()?
   At least a few lines above that place we check context != null before calling
   context.getCookies(), so it seems someone wasn't sure, whether context could
   be null or not. I propose adding
   http://svn.apache.org/viewvc?rev=944511&view=rev
   +1: rjung
   -1: kkolinko: I agree with the above comment, but not the patch:
    I'd be better to move the scName (or name it 'sessionCookieName')
    outside the loop.

   kkolinko: It would be better if context.getSessionCookieName() returned
    the same value (null) by default both in 6.0 and 7.0, so that the API were the same.
    We can backport ApplicationSessionCookieConfig.getSessionCookieName()
    method from TC7.

   kkolinko: "context." vs "getContext()." used inconsistently in Request.java#configureSessionCookie

   rjung: In Request.configureSessionCookie(): should there be a check
   for context != null before calling context.getSessionCookieDomain()?
   At least a few lines above that place we check context != null before calling
   context.getSessionCookiePath(), so it seems someone wasn't sure, whether context could
   be null or not. I propose adding
   http://people.apache.org/~rjung/patches/2010-05-14-context-null-check.patch
   It can't be directly applied to trunk which uses
   ApplicationSessionCookieConfig.createSessionCookie(). Do we need to add the null checks
   into that method?
   +1: rjung
   -1: 

* sessionCounter and expiredSessions declares as long instead of int.
  http://svn.apache.org/viewvc?view=revision&revision=934337
  +1: kfujino
  -1: kkolinko: I think that we cannot change o.a.c.Manager API in such way
    in a dot release. Alternative proposal below.
  -1: markt: We can't change the API in 6. It will have to wait until 7.

* Fix possible overflows when calculating session statistics
  Fixes a) miscalculating the "average" because of multiplication overflow,
  b) ArithmeticException division by zero when numExpired overflows.
  The fix for trunk is already provided by r934337.
  http://people.apache.org/~kkolinko/patches/2010-04-21_tc6_StandardSession_statistics.patch
  +1: kkolinko, markt, rjung
  -1:

* Improve the ChatServlet comet example and fix some issues there
  http://svn.apache.org/viewvc?rev=935105&view=rev
  +1: kkolinko, markt, rjung
  -1:

* Configure Tomcat to use HttpOnly for session cookies by default
  http://people.apache.org/~kkolinko/patches/2010-04-21_tc6_context_httpOnly.patch
  +1: kkolinko
  -0: markt - There wasn't consensus previosuly.
            - If you are going to change the default, do it in the code
  -1:

* Make the principal implement Serializable 
  http://svn.apache.org/viewvc?view=revision&revision=939491
  +1: fhanik, markt, kkolinko
  -1: 
  rjung: Should we add a serialVersionUID?

* Log unexpected errors in ApplicationContext#getResource() and #getResourceAsStream()
  This is inspired by https://issues.apache.org/bugzilla/show_bug.cgi?id=49218
  http://svn.apache.org/viewvc?rev=939551&view=rev
  +1: kkolinko, markt, rjung
  -1:

* If any error happens in shutdown hook, do not forget to shutdown the
  logging subsystem.

  We have to take care of it, because logging shutdown hook is already
  disabled at that place. This way the unwritten messages in the cache will
  not be lost. Also if any more messages will come later, Handler.reportError()
  will write the first one of them to stderr, thus they will leave us a trace,
  instead of being lost in a buffer.
  http://svn.apache.org/viewvc?rev=940064&view=rev
  +1: kkolinko, markt, kfujino
  -1:

* Backport a couple of loader fixes and enhancements:

  Expose properties of VirtualWebappLoader and WebappClassLoader via JMX.
  http://svn.apache.org/viewvc?view=revision&revision=936819
  +1: rjung
  -1: 

  Add property "searchExternalFirst" to WebappLoader:
  If set, the external repositories will be searched before
  the WEB-INF ones. Default (false) is unchanged behaviour.
  Also expose the new property via JMX and document it.
  http://svn.apache.org/viewvc?view=revision&revision=936823
  http://people.apache.org/~rjung/patches/2010-05-14-loader-backport-r936823.patch
  +1: rjung
  -1: 

  Expose the new WebappLoader flag in the VirtualWebappLoader,
  but allow alternative name searchVirtualFirst to make it
  consistent with the "virtual" terminology.
  Now you can decide, whether the virtual paths will
  be searched before the webapp or after it.
  If searched before, external resources take precendence
  over internal ones. Before that change one couldn't overwrite
  resources already present in the webapp.
  http://svn.apache.org/viewvc?view=revision&revision=936825
  http://people.apache.org/~rjung/patches/2010-05-14-loader-backport-r936825.patch
  +1: rjung
  -1: 

  Respect configurable search order in getURLs().
  http://svn.apache.org/viewvc?view=revision&revision=936892
  http://people.apache.org/~rjung/patches/2010-05-14-loader-backport-r936892.patch
  +1: rjung
  -1: 

  Add the new contextName property of WebappClassLoader
  to its toString() and expose a read only via JMX.
  http://svn.apache.org/viewvc?view=revision&revision=944396
  http://people.apache.org/~rjung/patches/2010-05-14-loader-backport-r944396.patch
  +1: rjung
  -1: 

