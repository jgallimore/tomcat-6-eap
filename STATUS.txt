================================================================================
  Licensed to the Apache Software Foundation (ASF) under one or more
  contributor license agreements.  See the NOTICE file distributed with
  this work for additional information regarding copyright ownership.
  The ASF licenses this file to You under the Apache License, Version 2.0
  (the "License"); you may not use this file except in compliance with
  the License.  You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
================================================================================

$Id$

                         =================================
                         Apache Tomcat 6.0 Patch Proposals
                         =================================


RELEASE SHOWSTOPPERS:


PATCHES ACCEPTED TO BACKPORT:
  [ start all new proposals below, under PATCHES PROPOSED. ]


PATCHES PROPOSED TO BACKPORT:
  [ New proposals should be added at the end of the list ]

* Backport cleanup of semantics of thisAccessedTime and
  lastAccessedTime for sessions:
  - preparational whitespace changes
    http://svn.apache.org/viewvc?rev=711695&view=rev
  - Give thisAccessedTime and lastAccessedTime for sessions
    a clear semantics:
    http://svn.apache.org/viewvc?rev=711711&view=rev
    - thisAccessedTime will be updated at the beginning and
      at the end of session use
    - lastAccessedTime will only be updated at the end of
      session use
    This means:
    - lastAccessedTime is the last access time of a session
      disregarding any request still being processed on.
      So this is good to use even from within a request
      to detect when its own session has been used last before.
    - thisAccessedTime already gets updated when a new request
      disregarding any request still being processed on.
      So this is better for any idleness check or information.
    - thisAccessedTime >= lastAccessedTime always
  - Port from StandardSession to DeltaSession
    http://svn.apache.org/viewvc?rev=711714&view=rev
  - Expose thisAccessedTime via the session interface
    and ManagerBase, so we can use it from outside the session.
    http://svn.apache.org/viewvc?rev=711716&view=rev
  - Make the classes checking session idleness use thisAccessedTime.
    http://svn.apache.org/viewvc?rev=711720&view=rev
    This is not for invalidation, only for displaying
    idle times and making persistance decisions.
  +1: rjung
   0: billbarker: generally agree with remm that this is too big of a change for the stable branch
                 but could agree to some of it if it was split into parts
   0: markt: Agree with Bill - smaller parts would be better
  -1: remm: no for TC 6.0
  -1: funkman : api change in Session.java for .x.x release

* Fix the maven stuff for the maven repo.
  Before it does't find tomcat-juli.jar and the remoteRepository seems broken .
  http://people.apache.org/~jfclere/patches/maven.patch
  +1: jfclere
  -1: fhanik - easier to pass in the root path (lib/bin) to the macro instead of hacking around it
               if we remove the SCP auto feature, then there should be something to replace it with
               (http://ant.apache.org/manual/OptionalTasks/scp.html)  

* Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=48545
  Truststores don't have to have passwords
  Based on a patch by 'smmwpf54'
  http://svn.apache.org/viewvc?view=revision&revision=910266
  +1: markt
  -1: jfclere: Doc says it should use keystorePass (http://tomcat.apache.org/tomcat-6.0-doc/config/http.html).
               so that would break existing configurations.
      markt: It shouldn't break existing configs. JSSE allows trust stores to be
             read without providing the password

* Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=48589
  Make JNDIRealm easier to extend
  Based on a patch by Candid Dauth
  http://svn.apache.org/viewvc?rev=910485&view=rev
  http://svn.apache.org/viewvc?rev=918489&view=rev (review feedback)
  +1: markt, kkolinko
  -1: 

  Additional patch:
  http://svn.apache.org/viewvc?rev=918803&view=rev
  +1: kkolinko, markt
  -1:

* Improve log messages when a potential leak is detected by including the name
  of the offending context
  http://svn.apache.org/viewvc?view=revision&revision=920298
  +1: markt, kkolinko
  -1: 

* Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=48629
  Allow user names as well as DNs to be used with the nested role search
  Add roleNested to the docs
  Patch provided by Felix Schumacher
  http://svn.apache.org/viewvc?rev=920422&view=rev
  +1: markt, kkolinko
  -1: 

* Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=48661
  Make error page behaviour consistent. If a response has been committed, include
  the error page
  http://svn.apache.org/viewvc?rev=920449&view=rev
  +1: markt, kkolinko
  -1: 

* Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=48729
  Return roles defined by both userRoleName and roleName mechanisms
  Patch provided by 'eric'
  +1: markt, kkolinko
  -1: 

* Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=48737
  Don't assume paths that start with /META-INF/... are always in JARs. This is
  not true for some IDEs
  Patch provided by Fabrizio Giustina
  http://svn.apache.org/viewvc?rev=920840&view=rev
  +1: markt, kkolinko
  -1: 

* Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=48760
  Ensure multiple threads do not end up with the same InputStream
  http://svn.apache.org/viewvc?rev=920858&view=rev
  +1: markt, kkolinko
  -1: 

* Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=48701
  Add system property to allow disabling enforcement of JSP.5.3
  The spec recommends, but does not require this enforcement.
  http://svn.apache.org/viewvc?rev=920880&view=rev
  +1: kkolinko, markt
  -1:

* Address https://issues.apache.org/bugzilla/show_bug.cgi?id=48007#c5
  Improve exception processing in CustomObjectInputStream#resolveClass(),
  to help find the cause behind BZ 48007.
  http://svn.apache.org/viewvc?rev=920912&view=rev
  +1: kkolinko, markt
  -1:

* Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=48701
  Take account of TagVariableInfo when implementing the rules of JSP.5.3
  http://people.apache.org/~markt/patches/2010-03-09-bug48701.patch
  +1: markt, kkolinko
  -1: 

* Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=48790
  Make maxActive thread safe. I almost marked this as WONTFIX. Only the fact
  that it is, technically, a bug stopped me.
  Simplified patch based on kkolinko's patch below
  http://svn.apache.org/viewvc?view=revision&revision=927037
  +1: markt, kkolinko
  -1: 

  I think it can be done more simply:
  http://people.apache.org/~kkolinko/patches/2010-03-16_tc6_bug48790.patch
  +1: kkolinko
  -1: markt - setMaxActive() also needs to use the update lock
              I'll revert my patch above and propose a new one based on this

* Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=48793
  Make catalina.sh more robust to different return values on different platforms
  Patch provided by Thomas GL
  http://svn.apache.org/viewvc?rev=921444&view=rev
  +1: markt, kkolinko
  -1: 

* Update to NSIS 2.46
  NSIS changelog: http://nsis.sourceforge.net/Docs/AppendixF.html#F.1.1
  http://svn.apache.org/viewvc?rev=921630&view=rev
  +1: kkolinko, markt
  -1:

* Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=48795
  Provide an option to allow recompilation on the next request following a JSP
  compilation error rather than waiting modifcationTestInterval before the next
  attempt
  http://svn.apache.org/viewvc?rev=922010&view=rev
  +1: markt
  -1: 

* Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=48903
  and https://issues.apache.org/bugzilla/show_bug.cgi?id=48694#c8
  Fix deadlock /sync issues in WebappClassLoader. Revert to using
  synchronized(this) as analysis and experience shows anything else will just
  cause problems
  The patch looks bug but it just removes the sync block and sync's the method
  http://svn.apache.org/viewvc?rev=927565&view=rev
  +1: markt, kkolinko
  -1: 

  Mark ResourceEntry.loadedClass as volatile.
  http://svn.apache.org/viewvc?rev=927877&view=rev
  +1: kkolinko
  -1:

* Correct SSL session timeout attribute name
  http://people.apache.org/~markt/patches/2010-03-18-SslSessionTimeout.patch
  +1: markt
  -1: 
   kkolinko: In NioEndpoint (and in AbstractEndpoint in trunk) there is
    #setSessionCacheTimeout(String). It will need renaming as well?
    Generally, I would be against renaming some attributes, but this one
    is already documented as "sessionTimeout" in config/http.xml, though,
    still, renaming might break someone's configurations.

* Fix cluster regression, previous incorrect patch
  http://svn.apache.org/viewvc?rev=924776&view=rev
  https://issues.apache.org/bugzilla/show_bug.cgi?id=48934
  +1: fhanik, markt, kkolinko
  -1: 

* Fix cross-context session expiration
  http://svn.apache.org/viewvc?rev=926716&view=rev
  +1: markt
  -1: 

* Add support for displaying the Spring Security user name in the manager app
  http://svn.apache.org/viewvc?rev=927062&view=rev
  +1: markt, kkolinko
  -1: 

* Re-fix https://issues.apache.org/bugzilla/show_bug.cgi?id=45015
  Parsing re-factoring caused a regression in quote handling
  http://svn.apache.org/viewvc?rev=927621&view=rev
  +1: markt, kkolinko
  -1: 

* Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=48717
  When a node joins a cluster and it receives all the current sessions, ensure
  the sessionCreated event is fired if the Manager is configured to replicate
  session events
  http://svn.apache.org/viewvc?rev=928482&view=rev
  +1: markt, kkolinko
  -1: 

* Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=48839
  Correctly handle multi-line headers with the NIO connector
  Patch suggested by Richa Baronia
  http://svn.apache.org/viewvc?rev=928695&view=rev
  +1: markt, kkolinko
  -1: 

* Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=48840
  If CDPATH is set, cd may result in output to stdout.
  Swallow the output. This is safe since the script outputs the value used for
  CATALINA_HOME so any issues will be visible then.
  Patch provided by mdietze
  +1: markt
  -1: 

* Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=48843
  Port deadlock prevention for worker allocation from NIO to BIO and APR
  http://people.apache.org/~markt/patches/2010-03-29-bug48843-tc6.patch
  +1: markt
  +1: kkolinko: I will work, but I think that leaving/re-entering
    synchronization when we are inside the loop is unneeded extra overhead.
    Thus I am proposing another patch below.
  -1: 

  Alternative patch:
  https://issues.apache.org/bugzilla/attachment.cgi?id=25225
  +1: kkolinko
  -1:

* Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=48862
  Port pero's patch to add backlog to JK ChannelSocket
  http://svn.apache.org/viewvc?view=revision&revision=493480
  +1: markt, kkolinko
  -1: 

* Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=48895
  Make clearing thread locals optional and disabled by default since it isn't
  thread-safe
  http://svn.apache.org/viewvc?rev=928798&view=rev
  +1: markt, kkolinko
  -1: 

* Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=48917
  Correct name of mod_jk module in ApacheConfig
  https://issues.apache.org/bugzilla/attachment.cgi?id=25132
  Patch provided by Todd Hicks
  +1: markt, kkolinko
  -1: 

* Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=49030
  Failure of one connector should not leave some connectors started and some
  ignored
  http://svn.apache.org/viewvc?rev=929521&view=rev
  +1: markt
  -1: 
  +0: kkolinko: good, but maybe we should also prevent against starting
    those connectors, that failed to initialize, in StandardService#start()?
    Also the message name (some generic name, "connector.failed"), vs.
    message text ("starting"),  vs. what actually happened (initialize()) -
    I won't insist on fixing that inconsistency.

* Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=48983
  Improve debug logging for situations when RemoteIpValve is bypassed
  https://issues.apache.org/bugzilla/attachment.cgi?id=25181
  Patch provided by Cyrille Le Clerc
  +1: markt
  -1: 
