================================================================================
  Licensed to the Apache Software Foundation (ASF) under one or more
  contributor license agreements.  See the NOTICE file distributed with
  this work for additional information regarding copyright ownership.
  The ASF licenses this file to You under the Apache License, Version 2.0
  (the "License"); you may not use this file except in compliance with
  the License.  You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
================================================================================

$Id$

                         =================================
                         Apache Tomcat 6.0 Patch Proposals
                         =================================


RELEASE SHOWSTOPPERS:


PATCHES ACCEPTED TO BACKPORT:
  [ start all new proposals below, under PATCHES PROPOSED. ]

PATCHES PROPOSED TO BACKPORT:
  [ New proposals should be added at the end of the list ]

* Fix issue where the first request for a deleted JSPs returns as if the JSP
  still exists.
  http://svn.apache.org/viewvc?view=rev&revision=683969
  +1: markt, funkman, kkolinko
   0: remm (looks risky, very minor problem), fhanik - minor problem, jim
  -1: 
  kkolinko: (Notes:
    1. This does not affect configurations where Jasper is run with
    development=false. In those configurations JSP removal is not detected
    at all.


    2. I think that, strictly speaking, JspCompilationContext#removed field
    has to be either volatile or AtomicInteger, or there must be
    synch(JspServletWrapper) when accessing it:

    JspCompilationContext#incrementRemoved() is always called from inside a
    synchronized(JspServletWrapper) block, but
    JspCompilationContext#isRemoved() is e.g. called in
    JspServletWrapper#service() which is not synchoronized.

    Of course, that happens only when development=true. Otherwise that
    field is always 0. Thus I am hesitant to adding volatile to it to not
    affect productive configurations. Maybe double-lock pattern is better
    (like one in JspServletWrapper#getServlet()).

    This issue with JspCompilationContext#removed field is not a blocker
    for this patch, because it exists independently of it. And I think it
    would be hardly noticeable, as it won't be observed if there were any
    (unrelated) synchs earlier in the same Thread, and e.g. with
    development=true mode there is a syncronized(this) block below in
    JspServletWrapper#service().
  )

* Backport cleanup of semantics of thisAccessedTime and
  lastAccessedTime for sessions:
  - preparational whitespace changes
    http://svn.apache.org/viewvc?rev=711695&view=rev
  - Give thisAccessedTime and lastAccessedTime for sessions
    a clear semantics:
    http://svn.apache.org/viewvc?rev=711711&view=rev
    - thisAccessedTime will be updated at the beginning and
      at the end of session use
    - lastAccessedTime will only be updated at the end of
      session use
    This means:
    - lastAccessedTime is the last access time of a session
      disregarding any request still being processed on.
      So this is good to use even from within a request
      to detect when its own session has been used last before.
    - thisAccessedTime already gets updated when a new request 
      disregarding any request still being processed on.
      So this is better for any idleness check or information.
    - thisAccessedTime >= lastAccessedTime always
  - Port from StandardSession to DeltaSession
    http://svn.apache.org/viewvc?rev=711714&view=rev
  - Expose thisAccessedTime via the session interface
    and ManagerBase, so we can use it from outside the session.
    http://svn.apache.org/viewvc?rev=711716&view=rev
  - Make the classes checking session idleness use thisAccessedTime.
    http://svn.apache.org/viewvc?rev=711720&view=rev
    This is not for invalidation, only for displaying
    idle times and making persistance decisions.
  +1: rjung
   0: billbarker: generally agree with remm that this is too big of a change for the stable branch
                 but could agree to some of it if it was split into parts
   0: markt: Agree with Bill - smaller parts would be better
  -1: remm: no for TC 6.0
  -1: funkman : api change in Session.java for .x.x release

* Fix Close Stream at WebappClassLoader after read error
  http://svn.apache.org/viewvc?rev=772872&view=rev 
  +1: pero, funkman
  -0: kkolinko: http://marc.info/?l=tomcat-dev&m=124192105131636&w=2
  -1:

* When throwing Non-serializable exception, mark which argument was
  non-serializable to help tracing the cause when developing.
  http://svn.apache.org/viewvc?rev=713953&view=rev
  http://svn.apache.org/viewvc?rev=714002&view=rev
  6.0.x version of the patch:
  http://people.apache.org/~mturk/tomcat/setAttribute1.iae.patch
  +1: mturk, kkolinko, markt
  -1:

* Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=38797
  Reverts previous fix for
  https://issues.apache.org/bugzilla/show_bug.cgi?id=37933 and implements an
  alternative that doesn't have the side effects described in 38797
  http://svn.apache.org/viewvc?rev=791224&view=rev
  +1: markt, kkolinko,funkman, jim
  -1:
  This also requires a second patch
  http://svn.apache.org/viewvc?rev=809131&view=rev
  +1: markt, jim, kkolinko
  -1: 

* Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=39231
  http://people.apache.org/~markt/patches/2009-08-16-bug39231.patch
  JAAS LoginContext expects a call to logout()
  +1: markt, jim, fhanik
  -1: 
 
* Improve NIO connector shutdown time by doing shutdowns in parallel
  and with a timeout
  http://svn.apache.org/viewvc?view=rev&revision=791914
  +1: fhanik, markt, kkolinko, jim
  -1: 
  kkolinko: (
    Some nit-picking:
    1. I think that it is better to create the stopLatch in the NioEndpoint#start()
    method right before the array of Pollers is created, instead of NioEndpoint#init().
    And to pass a reference to it to the Poller (as an argument in Poller
    constructor).
    That is because otherwise if you call stop() start() the stopLatch won't be in
    its initial condition, and because the count of pollers can be changed between
    init() and start(). Just a theory, though.
    
    2. In NioEndpoint.Poller#run():
    - if the Poller was looping with paused=true, is there a need to call
    events() before exiting the loop on if (close) ?
    - there are several ways to exit the loop: two if(close), one while
     (running), and may be exceptions. The first if(close) does not call
     selector.close(). And if you exit because of running = false there is
     no call to timeout(0, false); and selector.close().
    - there is special processing code for OutOfMemoryError, but inside the
     loop, and in events() method, you catch any Throwable.
    - it would be better to put stopLatch.countDown() inside a finally{} block
    3. In NioEndpoint.Poller#destroy() there is comment ("// Wait...").
    Is it still relevant? I do not see any waiting there.
  )

* Port TLD processing improvements from trunk
  There have been quite a few changes to TLD processing and they are tightly
  coupled. Therefore, this proposal is a series of patches and the patches
  need to be applied in order. Even then the patches do not apply completely
  cleanly so a rolled up patch has been provided at each stage.
  Note: The JSP TCK passes with the full set of patches applied.
  The benefit is twofold. First a number of edge case bugs I came across are
  fixed. The short version is that the Catalina code and the Jasper code did
  things differently. As well as the inherent inconsistencies (and hence bugs)
  this created it also made it much harder to add the additional functionality
  I was trying to add for embeddability. Which brings me to the second benefit.
  With these fixes in place, the changes I was trying to make (patch to follow
  when I have done more testing) for embeddability become possible.
  Step 1: Clean-up
  http://svn.apache.org/viewvc?view=rev&revision=647344
  +1: markt, kkolinko
  -1: 
  Step 2: Make validation configuration per-context
  http://svn.apache.org/viewvc?view=rev&revision=751502
  http://people.apache.org/~markt/patches/2009-08-06-TLD-improvements-steps-1-2.patch (Steps 1-2)
  +1: markt
  -1: 
  Step 3: Track and don't process duplicate TLDs
  http://svn.apache.org/viewvc?view=rev&revision=793621
  http://people.apache.org/~markt/patches/2009-08-06-TLD-improvements-steps-1-3.patch (Steps 1-3)
  +1: markt
  -1: 
  Step 4: Sync Catalina and Jasper code so a) they have the same behaviour and
  b) use the same code so they are easier to keep in sync.
  http://svn.apache.org/viewvc?view=rev&revision=795143
  http://svn.apache.org/viewvc?view=rev&revision=795767
  http://svn.apache.org/viewvc?view=rev&revision=795819
  http://svn.apache.org/viewvc?view=rev&revision=795822
  http://svn.apache.org/viewvc?view=rev&revision=795824
  http://svn.apache.org/viewvc?view=rev&revision=795838
  http://svn.apache.org/viewvc?view=rev&revision=795860
  http://svn.apache.org/viewvc?view=rev&revision=795902
  http://svn.apache.org/viewvc?view=rev&revision=796016
  http://svn.apache.org/viewvc?view=rev&revision=796017
  http://svn.apache.org/viewvc?view=rev&revision=796030
  http://svn.apache.org/viewvc?view=rev&revision=801601
  http://svn.apache.org/viewvc?view=rev&revision=801637
  http://people.apache.org/~markt/patches/2009-08-06-TLD-improvements-steps-1-4.patch (Steps 1-4)
  +1: markt
  -1: 

* Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=47158
  Update AccessLogValve and ExtendedAccessLogValve with all the recent threading
  improvements
  http://people.apache.org/~markt/patches/2009-08-15-AccessLogValve-tc6.patch
  +1: markt, kkolinko, fhanik
  -1:

  kkolinko: Also +1 to use StringBuilder everywhere in those classes, with
    exception of those places where it is passed as the argument to
    AccessLogValve.AccessLogElement#addElement().

* Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=47699
  Better handling of PID files
  https://issues.apache.org/bugzilla/attachment.cgi?id=24202
  +1: markt
  +1: fhanik (although, on .sh, I think we could get rid of 'Bootstrap stop' by now, shutdown hooks have been available for quite some time)
  -1: 
   
  

* Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=44041
  Threading issue in classloading. Adds a sync so please check performance
  http://svn.apache.org/viewvc?rev=805182&view=rev 
  +1: markt
   0: jim
  -1: fhanik, I would say a thread safe, yet concurrent implementation would do
      synchronized (className.intern()) {
        //perform class loading
      }
      instead of synchronizing the entire method and hence only allowing class loading one class at a time
      

* Allow per instance log4j.properties, JAR files (JDBC drivers) etc
  http://svn.apache.org/viewvc?rev=810916&view=rev
  http://svn.apache.org/viewvc?rev=810977&view=rev
  http://svn.apache.org/viewvc?rev=821397&view=rev
  +1: markt, kkolinko, fhanik
  -1:
  kkolinko: re RUNNING.txt update: it'd be better to replace "eg" with "e.g."

* Allow per instance configuration of JULI or log4j for core Tomcat logging
  This requires the classpath change above
  http://svn.apache.org/viewvc?rev=810976&view=rev
  +1: markt, rjung, fhanik
  -1: kkolinko: we should not remove tomcat-juli.jar from bootstrap.jar.manifest
  kkolinko: Regarding /res/bootstrap.jar.manifest change:
    It will cause problems e.g. in Eclipse IDE.
    If I configure a Tomcat server instance there, it is created with a
    classpath that consists only of bootstrap.jar and JDK's tools.jar. That
    has to be changed to include tomcat-juli.jar as well.
    While that is configurable, it is not so obvious (you have to click
    some underlined text on some wordy page) and there can be a lot of
    confusion when the product ceases functioning out-of-the box.

    I also like that I can run Tomcat easily by typing "java -jar bootstrap.jar start"
    That option will also be lost.

    I think that we can implement the same feature by adding
    ${CATALINA_BASE}/bin/tomcat-juli.jar to the classpath before
    bootstrap.jar   We can propose people to manually remove
    tomcat-juli.jar from ${CATALINA_HOME}/bin if they want, though I doubt
    that that will be necessary.

* Make FileHandler.java extensible
  http://svn.apache.org/viewvc/tomcat/trunk/java/org/apache/juli/FileHandler.java?r1=666232&r2=709018&pathrev=793882&view=patch
  +1: fhanik, jim, markt, kkolinko
  -1: 

* Allow configurable buffer size of loggers
  http://svn.apache.org/viewvc?rev=814708&view=rev
  http://svn.apache.org/viewvc?rev=814876&view=rev
  +1: fhanik, jim, markt, kkolinko
  -1:

* Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=46950
  Adds support for SSL renegotiation when CLIENT-CERT auth is required due to a
  security constraint
  Note: Patch cannot be applied until tc-native 1.1.17 has been released
        since it depends on a new native method
  http://svn.apache.org/viewvc?rev=815418&view=rev
  +1: markt, jfclere, fhanik
   0: jim
  -1: 

* Align native and Java method names.
  Port/backport from trunk, TC5.5.x, tc4.1.x and tcnative (trunk and 1.1.x)
  http://svn.apache.org/viewvc?rev=815748&view=rev
  http://svn.apache.org/viewvc?rev=815768&view=rev
  http://svn.apache.org/viewvc?rev=706574&view=rev
  Plus the last hunk for Socket.java in
  https://issues.apache.org/bugzilla/attachment.cgi?id=24276
  +1: rjung, markt, fhanik
  -1: 
  +1: kkolinko:(
    Should be applied when tc-native 1.1.17 is released,
    because of native method names and argument types changes.

    We will need to update minimum required version
    (in o.a.c.core.AprLifecycleListener, o.a.c.connector.Connector).

    Also, attachment.cgi?id=24276 looks like a wrong patch to vote.
    It is a documentation patch. There is no need to vote for it. And it is
    not for Socket.java.
  )
  rjung: Note that java/org/apache/tomcat/jni/Buffer.java
  is missing in TC 6. Don't know, whether we should add it.
  It is in 5.5, trunk and tcnative 1.1.
  markt: Happy either way with slight preference for adding it
  kkolinko: Either way is OK, but, as I cannot find any usages of Buffer
  methods neither in TC 5.5 nor in trunk, I would prefer to remove this
  class at least from trunk, but better from both, and even from native
  side.
  
* Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=47267
  http://svn.apache.org/viewvc?rev=817822&view=rev
  +1: markt
  -1:
  rjung: Our dreaded multi platform build system is a bit fragile
  w.r.t. fixcrlf. If you change the file to crlf in the installer
  target, then all unix packages (which are build after installer)
  will also contain it in crlf format. Not to bad for especially
  that file (because part of a webapp), but maybe it would
  be cleaner to do this for the installer target only, e.g.
  saving the file, fixcrlf, run nsi, restoring file.

  kkolinko: Another way to fix it would be to place a copy of that file
  into %CATALINA_HOME% (with proper CRLF endings) and display that one in
  the installer, leaving the one in the ROOT webapp as is. Note, that we
  already have these two copies of the file in our zip/tgz distributions.

* Fix cluster replication problem: session expiration uses a replication
  shortcut, so that attributes changed immediately before invalidation do
  not get replicated before the expiration replication message.
  That's a problem in case a session listener needs the changed attribute.
  Has already been fixed in trunk, OACC and tc5.5.x.
  http://svn.apache.org/viewvc?rev=818062&view=rev (trunk)
  +1: rjung, pero, fhanik
  -1: 

* Fix memory leak causes by a JRE implementation change in 1.6.0_15 onwards
  http://svn.apache.org/viewvc?view=revision&revision=828196
  http://svn.apache.org/viewvc?view=revision&revision=830378
  http://svn.apache.org/viewvc?view=revision&revision=830379
  +1: markt, kkolinko, fhanik
  -1: 

* Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=48019
  Be more careful about skipping over sections we aren't interested in
  http://svn.apache.org/viewvc?view=revision&revision=828201
  +1: markt, kkolinko, fhanik
  -1: 

* Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=48009
  Protect against a context file briefly disappearing due to text editor
  http://svn.apache.org/viewvc?view=revision&revision=828210
  +1: markt, kkolinko
  -1: 

* Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=47987
  Limit size of not found resources cache
  http://svn.apache.org/viewvc?rev=828759&view=rev
  +1: markt, kkolinko
  -1: 

* Refix https://issues.apache.org/bugzilla/show_bug.cgi?id=37848
  Don't output info messages when there is no terminal
  http://svn.apache.org/viewvc?rev=828225&view=rev
  +1: markt, kkolinko
  -1: 

* Use correct flag for SSL
  http://svn.apache.org/viewvc?rev=831106&view=rev
  +1: fhanik, kkolinko
  -1:

* Fix ReplicationValve CrossContext support
  http://svn.apache.org/viewvc?rev=831718&view=rev
  +1: pero
  -1:

* Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=47451
  Don't throw NPEs if the various response.setHeader() methods are called with
  null header name, zero length header name or null value. Silently ignore the
  calls the same way we do if the response has already been committed
  http://svn.apache.org/viewvc?rev=831774&view=rev
  +1: mark
  -1: 
