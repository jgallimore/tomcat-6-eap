================================================================================
  Licensed to the Apache Software Foundation (ASF) under one or more
  contributor license agreements.  See the NOTICE file distributed with
  this work for additional information regarding copyright ownership.
  The ASF licenses this file to You under the Apache License, Version 2.0
  (the "License"); you may not use this file except in compliance with
  the License.  You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
================================================================================

$Id$

                         =================================
                         Apache Tomcat 6.0 Patch Proposals
                         =================================


RELEASE SHOWSTOPPERS:


PATCHES ACCEPTED TO BACKPORT:
  [ start all new proposals below, under PATCHES PROPOSED. ]

PATCHES PROPOSED TO BACKPORT:
  [ New proposals should be added at the end of the list ]

* Fix the maven stuff for the maven repo.
  Before it does't find tomcat-juli.jar and the remoteRepository seems broken .
  http://people.apache.org/~jfclere/patches/maven.patch.100711
  +1: jfclere
  -1: fhanik - easier to pass in the root path (lib/bin) to the macro instead of hacking around it
               if we remove the SCP auto feature, then there should be something to replace it with
               (http://ant.apache.org/manual/OptionalTasks/scp.html)
  +1: kkolinko: +1 for the updated patch (maven.patch.100711)
      I still think that it is not so good to remove the old code of <remoteRepository/>,
      because it ignores ${maven.repo.url} parameter provided by deploy-snapshot,
      deploy-staging and deploy-release targets. Maybe leave old code as a comment
      and fix it later if needed? I think that actually nobody besides the release manager
      uses this, so I am letting this pass.

* Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=48545
  Truststores don't have to have passwords
  Based on a patch by 'smmwpf54'
  https://issues.apache.org/bugzilla/attachment.cgi?id=26268
  +1: kkolinko, markt, jfclere
  -1:

* Configure Tomcat to use HttpOnly for session cookies by default
  http://people.apache.org/~kkolinko/patches/2010-04-21_tc6_context_httpOnly.patch
  +1: kkolinko
  -0: markt - There wasn't consensus previously.
            - If you are going to change the default, do it in the code
  -1:

* Expose the new WebappLoader flag in the VirtualWebappLoader,
  but allow alternative name searchVirtualFirst to make it
  consistent with the "virtual" terminology.
  Now you can decide, whether the virtual paths will
  be searched before the webapp or after it.
  If searched before, external resources take precendence
  over internal ones. Before that change one couldn't overwrite
  resources already present in the webapp.
  http://svn.apache.org/viewvc?view=revision&revision=936825
  http://people.apache.org/~rjung/patches/2010-05-14-loader-backport-r936825.patch
  +1: rjung
  -1:
  -0: kkolinko: The patch itself is OK, but I think having a synonym will
   cause confusion. I'd prefer not to invent a new name, but mention the
   one that we already have when documenting virtualClasspath.

* Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=49555
  Correctly handle tag libraries that use functions defined in static inner
  classes
  http://svn.apache.org/viewvc?rev=961948&view=rev
  http://svn.apache.org/viewvc?rev=963106&view=rev
  http://svn.apache.org/viewvc?rev=966863&view=rev
  +1: markt, kkolinko
  -1:
   kkolinko: I was worried that ELFunctionMapper$PrivilegedGetTccl
   should be preloaded in o.a.jasper.security.SecurityClassLoad,
   but from debugging it looks that it is called by Tomcat code only
   (JspServlet).

* Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=49860
  Add support for trailing headers.
  http://svn.apache.org/viewvc?rev=1003461&view=rev
  http://svn.apache.org/viewvc?rev=1033415&view=rev
  Note: Don't change return type for parseEndChunk(), just return true.
  +1: markt, kkolinko, jfclere
  -1:
  kkolinko: Only if accompanied by a patch that sets limit on the maximum
  size of ChunkedInputFilter.trailingHeaders buffer. I am proposing such a
  patch below. Otherwise it would be vulnerable to a DOS.

  kkolinko: Additional patch:
  http://svn.apache.org/viewvc?rev=1033842&view=rev
  +1: kkolinko, markt, jfclere
  -1:

  kkolinko: Patch to impose limit on the trailers length:
  http://svn.apache.org/viewvc?rev=1037924&view=rev
  +1: kkolinko, markt, jfclere
  -1:

* Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=50026
  Force DefaultServlet to serve all resources relative to context root
  regardless of mappings/mount point.
  Prevents access to WEB-INF and META-INF when the default servlet is
  mapped to a sub-path. Also fixes WebdavServlet, which is affected for GET
  requests.
  This is a breaking change for anyone re-mapping DefaultServlet to a sub-path
  (current behaviour is to remount the entire web application under the path,
  which exposes WEB-INF/META-INF).
  http://svn.apache.org/viewvc?rev=1004393&view=rev
  http://svn.apache.org/viewvc?rev=1004409&view=rev
  http://svn.apache.org/viewvc?rev=1004415&view=rev
  http://svn.apache.org/viewvc?rev=1004912&view=rev (fix for includes)
  +1: timw
  +1: markt, kkolinko if http://svn.apache.org/viewvc?rev=1033897&view=rev
            is also applied
  -1:

* Fix path parameter handling. Currently the following URL fails with a 404:
  http://localhost:8080/examples/jsp/snp;x=y/snoop.jsp
  http://people.apache.org/~markt/patches/2010-10-06-path-param-tc6.patch
  +1: markt
  +1: kkolinko:
    with the following trivial changes:
     - with r1022389 and r1035973
     - with access logging as done by r1030188
     - Mark CoyoteAdapter.parseSessionId(..) as @deprecated, because it is no more used
       In the updated patch below I replaced its implementation with a call to parsePathParameters().
     - Add 'coyoteAdapter.parsePathParam' message to org/apache/catalina/connector/LocalStrings.properties
  -1:

    Updated patch, based on markt's one and my above comments:
  http://people.apache.org/~kkolinko/patches/2010-11-17_tc6_path-params.patch
  +1: kkolinko
  -1:

   kkolinko: The old parseSessionId() method calls "clearRequestedSessionURL(request);"
     when there is no sessionid in the path. The new code does not do that. Was that
     call needed? It looks that it was not needed, but I might miss something.

   kkolinko: Discussed in Re:r1005192 thread on dev@


* Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=50222
  Pin the system rather than the common class loader in memory which will
  work better in an embedded environment.
  Patch provided by Christopher Schultz.
  http://svn.apache.org/viewvc?rev=1033448&view=rev
  +1: kkolinko, markt, jfclere
  -1:

* Backport Windows installer improvements from Tomcat 7.0.5.

  - Add default --PidFile (new with daemon 1.0.3) (r982157, mturk)

  - Use *modern* types of nsis install/uninstall icons (r999976, mturk)

  - Create service-install.log file during installation with params that
  were used to invoke commons daemon. (r1003840, mturk; r1035083,r1035088 kkolinko)

  - Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=50140
  Don't ignore a user specified install directory on 64-bit platforms.
  - Allow 32-bit or 64-bit JVMs to be selected when installing on a 64-bit
  platform.
  (r1027504, markt; r1033856,r1033882 kkolinko)

  - Reimplemented the Windows installer GUI using nsDialogs and MUI2 libraries,
  instead of deprecated InstallOptions.
  The *.ini files are no more used. All is specified in the nsi script.
  (r1034911, kkolinko)

  - Use new admin-gui and manager-gui roles for the user (r982151, mturk)

  - Add a field to display/edit the roles for the user that we add to tomcat-user.xml
  - The roles are calculated depending on what webapps are installed
  (only manager, vs. host-manager, vs. both of them).
  - Do not display "username", "password", "roles" fields when neither
  manager nor host-manager are selected. In the previous version we showed
  them as disabled. Now we do not show them on screen.
  - Add support for the '/?' command line option. It displays a message box.
  See .onInit function in tomcat.nsi for details.
  (r1034911, kkolinko)

  - When installing on Windows, do not leave undeleted stale files in
  $TEMP/src/res/confinstall/. Pack only needed fines, not duplicates.
  Place those files into $PLUGINSDIR instead of $TEMP.
  - Add DetailPrint statements for operations that take noticeable time.
  (r1034924, kkolinko)

  - Improve descriptions of the components.
  (r964211, r1035051)

  Backported revisions:
  964211,982151,982157,999976,1003840,1027504,1033856,1033882,1034911,1034924,
  1034926,1035051,1035062,1035068,1035071,1035083,1035088,1035093,1035094,
  1035132

  1. Run the following SVN commands:
   svn del res/config.ini
   svn del res/jvm.ini
   svn del res/main.ico
   svn del res/uninst.ico
   # copy icons from TC7, see r999976
   svn copy ../../trunk/res/main.ico res/
   svn copy ../../trunk/res/uninst.ico res/
  2. Apply patch:
   http://people.apache.org/~kkolinko/patches/2010-11-15_tc6_tomcat-nsi.patch
  (
   For reference: here is the diff of tomcat.nsi of trunk @1035132 if I copy
   this patched tc6 version on top of it:
   http://people.apache.org/~kkolinko/patches/2010-11-15_tc6_tomcat-nsi-of-tc7_vs_tc6.diff
  )
   +1: kkolinko
   -1: markt - I found an issue with using a PID file in 7.0.x that prevents the
               service from starting (a second attempt succeeds). I am assuming
               6.0.x will also be affected. 

* Backport JSP unloading patch (BZ48358).
  The patch has substantially changed since the original version.
  Original revisions are: 937787, 1028377, 1028389, 1028396, 1028861, 1028862, 1028863,
  1028935, 1028939, 1028940, 1028944, 1028950, 1030014, 1030037
  Combined TC 6 patch:
  http://people.apache.org/~rjung/patches/BZ48358-JSP_Unloading-TC6_20101118.patch
  +1: rjung
  -1:

* Add session creation / expiration rate statistics to the session managers
  Adds ~10% to the session creation/destruction process when that is all Tomcat
  is doing. Should be less overhead with less contention.
  http://people.apache.org/~markt/patches/2010-11-18-session-rate-stats.patch
  +1: markt
  -1:

* Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=50273
  Provide a workaround for an HP-UX issue that can result in large numbers of
  SEVERE log messages appearing in the logs as a result of normal operation.
  http://svn.apache.org/viewvc?rev=1037715&view=rev
  +1: markt, kkolinko, jfclere
  -1:

* Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=50228
  Improve recycling of BodyContentImpl.
  http://svn.apache.org/viewvc?rev=1037794&view=rev
  +1: kkolinko
  -1:

* Configure manager and host-manager webapps to use HttpOnly for session cookies
  http://people.apache.org/~kkolinko/patches/2010-11-22_tc6_httpOnly.patch
  +1: kkolinko
  -1:

* Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=50316
  Fix minor glitch with display of negative values in Manager webapp
  http://svn.apache.org/viewvc?rev=1037887&view=rev
  +1: kkolinko
  -1:

* Backport AprEndpoint shutdown patch (BZ49795 and similar).
  http://people.apache.org/~mturk/tomcat/patches/tomcat-6.0.x-aprshutdown.patch
  +1: mturk
  -1:

* Make memory leak prevention code that clears ThreadLocal instances more robust
  against objects with toString() methods that throw exceptions.
  http://svn.apache.org/viewvc?rev=1038041&view=rev
  +1: markt, kkolinko, jfclere
  -1:

* Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=48837
  Extend threads local memory leak detection / fixing to classes loaded by the
  JSP class loaders
  Patch by Sylvain Laurent
  https://issues.apache.org/bugzilla/attachment.cgi?id=25116
  +1: markt
  -1:
