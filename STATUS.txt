================================================================================
  Licensed to the Apache Software Foundation (ASF) under one or more
  contributor license agreements.  See the NOTICE file distributed with
  this work for additional information regarding copyright ownership.
  The ASF licenses this file to You under the Apache License, Version 2.0
  (the "License"); you may not use this file except in compliance with
  the License.  You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
================================================================================

$Id$

                         =================================
                         Apache Tomcat 6.0 Patch Proposals
                         =================================


RELEASE SHOWSTOPPERS:


PATCHES ACCEPTED TO BACKPORT:
  [ start all new proposals below, under PATCHES PROPOSED. ]

PATCHES PROPOSED TO BACKPORT:
  [ New proposals should be added at the end of the list ]

* Fix the maven stuff for the maven repo.
  Before it does't find tomcat-juli.jar and the remoteRepository seems broken .
  http://people.apache.org/~jfclere/patches/maven.patch.100711
  +1: jfclere
  -1: fhanik - easier to pass in the root path (lib/bin) to the macro instead of hacking around it
               if we remove the SCP auto feature, then there should be something to replace it with
               (http://ant.apache.org/manual/OptionalTasks/scp.html)
  +1: kkolinko: +1 for the updated patch (maven.patch.100711)
      I still think that it is not so good to remove the old code of <remoteRepository/>,
      because it ignores ${maven.repo.url} parameter provided by deploy-snapshot,
      deploy-staging and deploy-release targets. Maybe leave old code as a comment
      and fix it later if needed? I think that actually nobody besides the release manager
      uses this, so I am letting this pass.

* Configure Tomcat to use HttpOnly for session cookies by default
  http://people.apache.org/~kkolinko/patches/2010-04-21_tc6_context_httpOnly.patch
  +1: kkolinko
  -0: markt - There wasn't consensus previously.
            - If you are going to change the default, do it in the code
  -1:

* Expose the new WebappLoader flag in the VirtualWebappLoader,
  but allow alternative name searchVirtualFirst to make it
  consistent with the "virtual" terminology.
  Now you can decide, whether the virtual paths will
  be searched before the webapp or after it.
  If searched before, external resources take precendence
  over internal ones. Before that change one couldn't overwrite
  resources already present in the webapp.
  http://svn.apache.org/viewvc?view=revision&revision=936825
  http://people.apache.org/~rjung/patches/2010-05-14-loader-backport-r936825.patch
  +1: rjung
  -1:
  -0: kkolinko: The patch itself is OK, but I think having a synonym will
   cause confusion. I'd prefer not to invent a new name, but mention the
   one that we already have when documenting virtualClasspath.

* Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=49555
  Correctly handle tag libraries that use functions defined in static inner
  classes
  http://svn.apache.org/viewvc?rev=961948&view=rev
  http://svn.apache.org/viewvc?rev=963106&view=rev
  http://svn.apache.org/viewvc?rev=966863&view=rev
  +1: markt, kkolinko
  -1:
   kkolinko: I was worried that ELFunctionMapper$PrivilegedGetTccl
   should be preloaded in o.a.jasper.security.SecurityClassLoad,
   but from debugging it looks that it is called by Tomcat code only
   (JspServlet).

* Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=50026
  Force DefaultServlet to serve all resources relative to context root
  regardless of mappings/mount point.
  Prevents access to WEB-INF and META-INF when the default servlet is
  mapped to a sub-path. Also fixes WebdavServlet, which is affected for GET
  requests.
  This is a breaking change for anyone re-mapping DefaultServlet to a sub-path
  (current behaviour is to remount the entire web application under the path,
  which exposes WEB-INF/META-INF).
  http://svn.apache.org/viewvc?rev=1004393&view=rev
  http://svn.apache.org/viewvc?rev=1004409&view=rev
  http://svn.apache.org/viewvc?rev=1004415&view=rev
  http://svn.apache.org/viewvc?rev=1004912&view=rev (fix for includes)
  +1: timw
  +1: markt, kkolinko if http://svn.apache.org/viewvc?rev=1033897&view=rev
            is also applied
  -1:

* Fix path parameter handling. Currently the following URL fails with a 404:
  http://localhost:8080/examples/jsp/snp;x=y/snoop.jsp
  http://people.apache.org/~kkolinko/patches/2010-11-17_tc6_path-params.patch
  +1: kkolinko, markt
  -1:

   kkolinko: The old parseSessionId() method calls "clearRequestedSessionURL(request);"
     when there is no sessionid in the path. The new code does not do that. Was that
     call needed? It looks that it was not needed, but I might miss something.

   kkolinko: Discussed in Re:r1005192 thread on dev@


* Backport Windows installer improvements from Tomcat 7.0.5.

  - Use *modern* types of nsis install/uninstall icons (r999976, mturk)

  - Create service-install.log file during installation with params that
  were used to invoke commons daemon. (r1003840, mturk; r1035083,r1035088 kkolinko)

  - Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=50140
  Don't ignore a user specified install directory on 64-bit platforms.
  - Allow 32-bit or 64-bit JVMs to be selected when installing on a 64-bit
  platform.
  (r1027504, markt; r1033856,r1033882 kkolinko)

  - Reimplemented the Windows installer GUI using nsDialogs and MUI2 libraries,
  instead of deprecated InstallOptions.
  The *.ini files are no more used. All is specified in the nsi script.
  (r1034911, kkolinko)

  - Use new admin-gui and manager-gui roles for the user (r982151, mturk)

  - Add a field to display/edit the roles for the user that we add to tomcat-user.xml
  - The roles are calculated depending on what webapps are installed
  (only manager, vs. host-manager, vs. both of them).
  - Do not display "username", "password", "roles" fields when neither
  manager nor host-manager are selected. In the previous version we showed
  them as disabled. Now we do not show them on screen.
  - Add support for the '/?' command line option. It displays a message box.
  See .onInit function in tomcat.nsi for details.
  (r1034911, kkolinko)

  - When installing on Windows, do not leave undeleted stale files in
  $TEMP/src/res/confinstall/. Pack only needed fines, not duplicates.
  Place those files into $PLUGINSDIR instead of $TEMP.
  - Add DetailPrint statements for operations that take noticeable time.
  (r1034924, kkolinko)

  - Improve descriptions of the components.
  (r964211, r1035051)

  Backported revisions:
  964211,982151,982157,999976,1003840,1027504,1033856,1033882,1034911,1034924,
  1034926,1035051,1035062,1035068,1035071,1035083,1035088,1035093,1035094,
  1035132, 1038975

  1. Run the following SVN commands:
   svn del res/config.ini
   svn del res/jvm.ini
   svn del res/main.ico
   svn del res/uninst.ico
   # copy icons from TC7, see r999976
   svn copy ../../trunk/res/main.ico res/
   svn copy ../../trunk/res/uninst.ico res/
  2. Apply patch:
   http://people.apache.org/~kkolinko/patches/2010-12-02_tc6_tomcat-nsi.patch
  (
   For reference: here is the diff of tomcat.nsi of trunk @1041257 if I copy
   this patched tc6 version on top of it:
   http://people.apache.org/~kkolinko/patches/2010-12-02_tc6_tomcat-nsi-of-tc7_vs_tc6.diff
  )
   +1: kkolinko, markt
   -1: 

* Backport JSP unloading patch (BZ48358).
  The patch has substantially changed since the original version.
  Original revisions are: 937787, 1028377, 1028389, 1028396, 1028861, 1028862, 1028863,
  1028935, 1028939, 1028940, 1028944, 1028950, 1030014, 1030037
  Combined TC 6 patch:
  http://people.apache.org/~rjung/patches/BZ48358-JSP_Unloading-TC6_20101118.patch
  +1: rjung
  -0: markt - http://markmail.org/thread/777be426ulcfmdd3 suggests there may be
              a memory leak in this code somewhere. I'd like to get to the
              bottom of that before porting this
      rjung:  I started a discussion about JSPs and memory on the dev list.
              The updated patch fixes a race condition.
              We can stall this item until we get some feedback about 7.0.5.
  -1:

* Add session creation / expiration rate statistics to the session managers
  Adds ~10% to the session creation/destruction process when that is all Tomcat
  is doing. Should be less overhead with less contention.
  http://people.apache.org/~markt/patches/2010-11-18-session-rate-stats.patch
  +1: markt
  -1:

* Backport AprEndpoint shutdown patch (BZ49795 and similar).
  http://people.apache.org/~mturk/tomcat/patches/tomcat-6.0.x-aprshutdown.patch
  +1: mturk
  -0: markt - Patch doesn't apply cleanly to tc6.0.x/trunk
  -1:

* Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=50201
  Handle ROOT webapp redeployment, host start/stop etc for default access log
  http://people.apache.org/~markt/patches/2010-12-05-bug50201-tc6.patch
  +1: markt
  -1: kkolinko:
  1) A typo: in "checkHost = ((ContainerBase) context).started;"
     should be s/checkHost/checkContext/
     markt: Fixed in updated patch above
  2) Possible NPEs in StandardEngine.logAccess(). With the old code
     the defaultAccessLog field can be checked once, and we know that
     if it is already not-null it will never become null. That is no
     longer the case and subsequent accesses to that volatile field can result
     in NPE. One needs to keep a local copy of that field.
     markt: Fixed in updated patch above
  3) addPropertyChangeListener(l). If we are only interested in "defaultHost"
     property change, shouldn't we add the listener to StandardEngine?
     I think that there is no need to add it to Context or Host (and
     are they notified about that change at all?).
     markt: Fixed in updated patch above
  4) Initializing defaultAccessLog may be performed by several threads
     concurrently. That may result in several listener instances being
     added. (It won't break their operation, but it is just a waste).
     markt: Agreed it is a waste. Can't do much about it without lots and lots
            of complexity.
  5) in AccessLogListener.containerEvent():
     Context context = (Context) event.getData();
     Maybe it'd be better to add an instanceof check before that cast.
     markt: Not worth it. That object has to be an instance of Context else all
            sorts of stuff would break way before the code got this far.
  6) In the proposed patch the Listener is only installed iff there
     is an access log there. It should be installed unconditionally.
     E.g., if Tomcat starts without access logs, NoopAccessLog is created.
     As there are no listeners, any change to the configuration
     (e.g. redeploying the ROOT webapp) will pass unnoticed
     and won't reenable the access log.
     markt: Fixed in updated patch above

  kkolinko: (Re: markt's 2010-12-05-bug50201-tc6.patch)
  7) Why "Lifecycle.DESTROY_EVENT.endsWith(type)" in a condition?
     s/endsWith/equals/
     markt: Auto-complete snafu - fixed in trunk
  8) I do not see how the listener can be reused when recalculation
     happens.
     (We are now installing a new listener when NoAccessLog wins,
     so my understanding is that it is no more necessary to wait for
     reuse there. The new listener will catch all the necessary events).
     Thus all events that force recalculation should result
     in disabling the listener.
  9) I propose to use an AtomicReference to guard against registering
     duplicate listeners (a fix for 4)). See the patch.
  10) I added install() and uninstall() method to AccessLogListener
      to help register/unregister the listeners.
  Here is an amended version of Mark's patch that includes 7),8),9),10). 
  I have not applied those changes to TC7 yet, and it might need some more
  testing:
  http://people.apache.org/~kkolinko/patches/2010-12-07_tc6_bug50201.patch
  markt: +1 to making these changes in TC7


* Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=48973
  Avoid creating file SESSIONS.ser if there's no session.
  The patch provided by Marc Guillemot works for tc 6 & 7
  http://svn.apache.org/viewvc?rev=1042022&view=rev
  +1: slaurent, kkolinko
  -0: markt - See http://markmail.org/message/xp5beek4mdacygsc
  -1:

  Additional patch: i18n, as asked by Mark:
  http://svn.apache.org/viewvc?rev=1044944&view=rev
  +1: kkolinko
  -1:

* Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=50282
  Improve JreMemoryLeakPreventionListener to load 
  javax.security.auth.login.Configuration to avoid redeployment leak.
  http://svn.apache.org/viewvc?rev=1042029&view=rev
  +1: slaurent, kkolinko
  -0: markt - See http://markmail.org/message/mnowpijhnxg554t5
  -1:

  Additional patches: (line wrapping and docs spelling)
  http://svn.apache.org/viewvc?view=revision&revision=1042452
  http://svn.apache.org/viewvc?view=revision&revision=1042447
  http://svn.apache.org/viewvc?view=revision&revision=1042494
  +1: kkolinko
  -1:

* Make SSL protocol selection consistent between BIO and NIO and update docs
  to reflect current BIO and post-patch NIO.
  http://people.apache.org/~markt/patches/2010-12-07-ssl-algorithm-tc6.patch
  +1: markt, kkolinko
  -1:

* Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=50413
  Ensure 304s are not returned when using static files as error pages
  http://svn.apache.org/viewvc?view=revision&revision=1044266
  +1: markt, kkolinko
  -1:

* Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=50459 
  StandardContext.bindThread() and unbindThread() are not symmetrical and not 
  limited to current thread
  http://people.apache.org/~slaurent/patches/2010-12-12_BZ50459_bindThread_tc6.patch
  +1: slaurent